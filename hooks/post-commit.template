#!/usr/bin/env bash
# post-commit hook — generated by reviewer_agent/install_hooks.py
# This hook runs the AutoGen reviewer agent after every commit.

REVIEWER_AGENT_DIR="{{REVIEWER_AGENT_DIR}}"
PYTHON="{{PYTHON}}"
REPO_DIR="$(git rev-parse --show-toplevel)"

# ── Configuration ────────────────────────────────────────────────────────────
# Set to "true" to run in the background (non-blocking commits).
# Set to "false" to block until the review is done (shows output in terminal).
BACKGROUND="false"

# Persistent log file so you can always read the latest review,
# even when committing from VS Code's Source Control UI.
REVIEW_LOG="$REPO_DIR/.git/last-review.log"
# ─────────────────────────────────────────────────────────────────────────────

COMMIT_SHA=$(git -C "$REPO_DIR" rev-parse --short HEAD)

run_review() {
    cd "$REVIEWER_AGENT_DIR" || exit 1

    {
        echo ""
        echo "═══════════════════════════════════════════════════════"
        echo "  Code Review  (commit $COMMIT_SHA)  $(date '+%Y-%m-%d %H:%M:%S')"
        echo "═══════════════════════════════════════════════════════"
        "$PYTHON" -m reviewer "$REPO_DIR" 2>&1
        echo "═══════════════════════════════════════════════════════"
    } | tee "$REVIEW_LOG"
}

if [ "$BACKGROUND" = "true" ]; then
    echo "Reviewer agent is analyzing commit $COMMIT_SHA in the background ..."
    echo "Review will be saved to: $REVIEW_LOG"
    run_review > /dev/null &
else
    echo "Reviewer agent is analyzing commit $COMMIT_SHA ..."
    run_review
fi
